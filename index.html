<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Eventos - Homens à Mesa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s, bottom 0.3s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow-x: hidden;
            overflow-y: hidden;
        }
        /* Style for file input */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-input-button {
            border: 1px solid #ccc;
            display: inline-block;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 6px;
            background-color: #f0f0f0;
            font-size: 12px;
            font-weight: 500;
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-6">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Projeto Homens à Mesa</h1>
            <p class="text-md text-gray-600 mt-2">Painel de Organização de Eventos</p>
        </header>

        <!-- Dashboard View -->
        <main id="dashboard-view">
            <!-- Summary Section -->
            <div id="summary-section" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                <!-- Balance Card -->
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center">
                    <div class="bg-green-100 p-4 rounded-full mr-4">
                        <i class="fas fa-wallet text-2xl text-green-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 font-medium">Saldo Atual em Caixa</p>
                        <p id="total-balance" class="text-3xl font-bold text-gray-800">R$ 0,00</p>
                    </div>
                </div>
                <!-- Participants Card -->
                <div id="participants-card" class="bg-white p-6 rounded-xl shadow-lg flex items-center hover:shadow-xl transition-shadow duration-300 cursor-pointer">
                    <div class="bg-blue-100 p-4 rounded-full mr-4">
                        <i class="fas fa-users text-2xl text-blue-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 font-medium">Homens Cadastrados</p>
                        <p id="total-participants" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-700">Agenda de Eventos</h2>
                <button id="add-event-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 flex items-center">
                    <i class="fas fa-plus mr-2"></i> Adicionar Evento
                </button>
            </div>
            <div id="events-grid">
                <!-- Event cards will be dynamically inserted here by year and month -->
            </div>
        </main>

        <!-- Event Detail View (Initially Hidden) -->
        <section id="event-detail-view" class="hidden">
            <button id="back-to-dashboard" class="mb-6 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Voltar para o Painel
            </button>
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 border-b pb-4">
                    <div>
                        <h2 id="event-title" class="text-3xl font-bold text-gray-900"></h2>
                        <p id="event-date-location" class="text-lg text-gray-500 mt-1"></p>
                    </div>
                    <div id="event-type-badge" class="mt-4 md:mt-0 text-sm font-medium px-4 py-2 rounded-full"></div>
                </div>
                <div class="border-b border-gray-200 mb-6">
                    <nav id="tabs" class="flex flex-wrap -mb-px" aria-label="Tabs"></nav>
                </div>
                <div id="tab-content"></div>
            </div>
        </section>

    </div>
    
    <!-- Participants Modal -->
    <div id="participants-modal" class="modal pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center opacity-0">
        <div id="participants-modal-overlay" class="absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded-xl shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-2xl font-bold">Homens Cadastrados</p>
                    <div class="close-modal cursor-pointer z-50 p-2">
                        <i class="fas fa-times text-2xl text-gray-500 hover:text-gray-800"></i>
                    </div>
                </div>
                <div class="my-5 h-64 overflow-y-auto pr-2">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-3 font-semibold text-sm">Nome</th>
                                <th class="p-3 font-semibold text-sm">Telefone</th>
                                <th class="p-3 font-semibold text-sm text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="participants-list"></tbody>
                    </table>
                </div>
                <div class="pt-4 border-t">
                     <p class="text-lg font-semibold mb-2">Adicionar Novo Participante</p>
                     <div class="flex flex-col md:flex-row md:space-x-2 space-y-2 md:space-y-0">
                        <input id="new-participant-name" type="text" placeholder="Nome completo" class="w-full p-2 border rounded-md">
                        <input id="new-participant-phone" type="tel" placeholder="Telefone" class="w-full md:w-auto p-2 border rounded-md">
                        <button id="add-participant-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">Adicionar</button>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="event-modal" class="modal pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center opacity-0">
        <div id="event-modal-overlay" class="absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <p id="event-modal-title" class="text-2xl font-bold">Adicionar Evento</p>
                    <div class="close-modal cursor-pointer z-50 p-2">
                         <i class="fas fa-times text-2xl text-gray-500 hover:text-gray-800"></i>
                    </div>
                </div>
                <div class="my-5 space-y-4">
                    <input type="hidden" id="event-id-input">
                    <div>
                        <label for="event-date-input" class="block text-sm font-medium text-gray-700">Data</label>
                        <input type="date" id="event-date-input" class="mt-1 w-full p-2 border rounded-md">
                    </div>
                     <div>
                        <label for="event-type-input" class="block text-sm font-medium text-gray-700">Tipo de Evento</label>
                        <select id="event-type-input" class="mt-1 w-full p-2 border rounded-md bg-white">
                            <option>Homens à Mesa</option>
                            <option>Encontrão de Homens</option>
                            <option>Culto de Homens</option>
                        </select>
                    </div>
                    <div>
                        <label for="event-location-input" class="block text-sm font-medium text-gray-700">Local</label>
                        <input type="text" id="event-location-input" class="mt-1 w-full p-2 border rounded-md">
                    </div>
                </div>
                <div class="flex justify-end pt-4 border-t">
                    <button class="close-modal bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg mr-2">Cancelar</button>
                    <button id="save-event-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        document.addEventListener('DOMContentLoaded', function () {
            
            // ===============================================================================================
            // AÇÃO NECESSÁRIA: CORRIJA AS CONFIGURAÇÕES DO FIREBASE
            //
            // Os erros "auth/configuration-not-found" e "Missing or insufficient permissions" indicam
            // que seu projeto Firebase precisa de duas configurações manuais para funcionar.
            // O código está correto, mas o acesso ao Firebase está bloqueado por segurança.
            //
            // SIGA ESTES PASSOS NO SEU PAINEL DO FIREBASE:
            //
            // PASSO 1: ATIVAR O LOGIN ANÔNIMO (Corrige 'auth/configuration-not-found')
            //    - No menu, vá em: Authentication -> Aba "Sign-in method".
            //    - Na lista, clique em "Anônimo".
            //    - Ative a chave e clique em "Salvar".
            //
            // PASSO 2: ATUALIZAR AS REGRAS DE SEGURANÇA (Corrige 'Missing or insufficient permissions')
            //    - a) Vá para "Firestore Database" -> Aba "Rules" (Regras).
            //       - Substitua TUDO pelas regras abaixo e clique em "Publish" (Publicar):
            //
            //         rules_version = '2';
            //         service cloud.firestore {
            //           match /databases/{database}/documents {
            //             match /homens-a-mesa-dados/{userId} {
            //               allow read, write: if request.auth != null && request.auth.uid == userId;
            //             }
            //           }
            //         }
            //
            //    - b) Vá para "Storage" -> Aba "Rules" (Regras).
            //       - Substitua TUDO pelas regras abaixo e clique em "Publish" (Publicar):
            //
            //         rules_version = '2';
            //         service firebase.storage {
            //           match /b/{bucket}/o {
            //             match /receipts/{userId}/{allPaths=**} {
            //               allow read, write: if request.auth != null && request.auth.uid == userId;
            //             }
            //           }
            //         }
            //
            // APÓS SEGUIR ESTES PASSOS, OS ERROS SERÃO RESOLVIDOS.
            // ===============================================================================================

            // --- FIREBASE SETUP ---
            let auth, db, storage, userId;
            
            const firebaseConfig = {
                apiKey: "AIzaSyBmGyAmYSQaaOVxOswSmGj3vJwwdRodnqI",
                authDomain: "homens-a-mesa-95468.firebaseapp.com",
                projectId: "homens-a-mesa-95468",
                storageBucket: "homens-a-mesa-95468.appspot.com",
                messagingSenderId: "296420733395",
                appId: "1:296420733395:web:1d9f60bd1d92060022ff26",
                measurementId: "G-BW6TQCLTMG"
            };

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showToast("Erro de conexão com o servidor.");
                return;
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in.
                    userId = user.uid;
                    loadDataFromFirestore();
                } else {
                    // User is signed out. Attempt to sign in anonymously.
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error);
                        showToast("Falha na autenticação. Verifique as configurações do Firebase.");
                    }
                }
            });

            // --- DATA ---
            let participantsData = [];
            let eventsData = [];

            async function saveDataToFirestore() {
                if (!userId) return;
                const dataDocRef = doc(db, 'homens-a-mesa-dados', userId);
                try {
                    await setDoc(dataDocRef, { 
                        participants: participantsData,
                        events: eventsData
                    });
                } catch (error) {
                    console.error("Error saving data: ", error);
                    showToast("Erro ao salvar dados.");
                }
            }

            function loadDataFromFirestore() {
                if (!userId) return;
                const dataDocRef = doc(db, 'homens-a-mesa-dados', userId);
                
                onSnapshot(dataDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        participantsData = data.participants || [];
                        eventsData = data.events || [];
                    } else {
                        console.log("No data found, setting up default data.");
                        initializeDefaultData();
                        saveDataToFirestore(); 
                    }
                    renderDashboard();
                }, (error) => {
                    console.error("Error listening to data:", error);
                    showToast("Erro de permissão. Verifique as Regras de Segurança do Firestore.");
                });
            }
            
            function initializeDefaultData() {
                participantsData = [
                    { id: 1, name: 'Marcos', phone: '21987654321' }, { id: 2, name: 'Pr Eric', phone: '' }, { id: 3, name: 'Lucas Porto', phone: '' }, { id: 4, name: 'Talisson', phone: '' }, { id: 5, name: 'Neander', phone: '' }, { id: 6, name: 'Alessandro (Rowena)', phone: '' }, { id: 7, name: 'Delcir', phone: '' }, { id: 8, name: 'Pedrinho', phone: '' },
                ];
                eventsData = [
                    { id: 1, date: '2025-10-05', type: 'Homens à Mesa', location: 'Sítio em Monjolos', planning: "1. Definir o tema do encontro e o palestrante.\n2. Preparar o material de estudo e dinâmicas.\n3. Organizar a escala de louvor.\n4. Fazer a lista de compras detalhada.", tasks: [ { name: 'Confirmar com o Pr Eric a palavra', responsible: 'Marcos', status: 'Concluído' }, { name: 'Organizar louvor', responsible: 'Lucas Porto', status: 'Em andamento' }, { name: 'Fazer as compras (carne, bebidas, etc)', responsible: 'Alessandro', status: 'Pendente' }, { name: 'Ligar para os convidados para confirmar presença', responsible: 'Marcos', status: 'Pendente' } ], finances: { income: [ { description: 'Oferta inicial do ministério', amount: 200.00 } ], expenses: [ { description: 'Carvão e acendedores', amount: 35.50 } ] }, guests: ['Pr Eric', 'Lucas Porto', 'Talisson', 'Neander', 'Alessandro (Rowena)', 'Delcir', 'Pedrinho'], volunteers: ['Marcos', 'Neander (Churrasco)', 'Alessandro (Compras)'] },
                    { id: 2, date: '2025-11-15', type: 'Encontrão de Homens', location: 'Sítio em Tanguá', planning: "1. Divulgação massiva no púlpito e nos Grupos de Conexão (GCs).\n2. Organizar opções de transporte (caronas solidárias, van).\n3. Definir cardápio completo do churrasco e acompanhamentos.\n4. Planejar atividades de lazer e gincanas.", tasks: [], finances: { income: [], expenses: [] }, guests: ['Aberto para todos os homens da Igreja'], volunteers: [] },
                    { id: 3, date: '2025-12-07', type: 'Homens à Mesa', location: 'Sítio em Monjolos', planning: "", tasks: [], finances: { income: [], expenses: [] }, guests: [], volunteers: [] },
                ];
                generate2026Schedule();
            }
            
            function generate2026Schedule() {
                const year = 2026;
                const specialEvents = [
                    { month: 3, date: `${year}-04-19`, type: 'Culto de Homens', location: 'Igreja' }, // April
                    { month: 5, date: `${year}-06-21`, type: 'Encontrão de Homens', location: 'Sítio em Tanguá' }, // June
                    { month: 8, date: `${year}-09-20`, type: 'Culto de Homens', location: 'Igreja' }, // September
                    { month: 10, date: `${year}-11-15`, type: 'Encontrão de Homens', location: 'Sítio em Tanguá' }, // November
                ];
                const specialEventMonths = specialEvents.map(e => e.month);
                for (let month = 0; month < 12; month++) {
                    if (specialEventMonths.includes(month)) {
                        const eventData = specialEvents.find(e => e.month === month);
                        eventsData.push({ id: Date.now() + month, date: eventData.date, type: eventData.type, location: eventData.location, planning: "", tasks: [], finances: { income: [], expenses: [] }, guests: [], volunteers: [] });
                    } else {
                        const firstDay = new Date(year, month, 1);
                        const dayOfWeek = firstDay.getDay();
                        const firstSunday = new Date(firstDay);
                        firstSunday.setDate(1 - dayOfWeek + (dayOfWeek > 0 ? 7 : 0));
                        const dateString = firstSunday.toISOString().split('T')[0];
                        eventsData.push({ id: Date.now() + month, date: dateString, type: 'Homens à Mesa', location: 'Sítio em Monjolos', planning: "", tasks: [], finances: { income: [], expenses: [] }, guests: [], volunteers: [] });
                    }
                }
            }


            // --- DOM ELEMENTS ---
            const dashboardView = document.getElementById('dashboard-view');
            const eventDetailView = document.getElementById('event-detail-view');
            const eventsGrid = document.getElementById('events-grid');
            const backButton = document.getElementById('back-to-dashboard');
            const tabContentContainer = document.getElementById('tab-content');
            
            // --- UTILITY FUNCTIONS ---
            function formatDate(dateString) { const options = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'UTC' }; return new Date(dateString).toLocaleDateString('pt-BR', options); }
            function getBadgeStyles(eventType) { switch (eventType) { case 'Homens à Mesa': return 'bg-blue-100 text-blue-800'; case 'Encontrão de Homens': return 'bg-green-100 text-green-800'; case 'Culto de Homens': return 'bg-purple-100 text-purple-800'; default: return 'bg-gray-100 text-gray-800'; } }
            function showToast(message) { const toast = document.getElementById('toast'); toast.textContent = message; toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }
            
            // --- MODAL GENERIC LOGIC ---
            function setupModal(modalId) {
                const modal = document.getElementById(modalId);
                const overlay = document.getElementById(`${modalId}-overlay`);
                const closeButtons = modal.querySelectorAll('.close-modal');
                const open = () => { modal.classList.remove('pointer-events-none', 'opacity-0'); document.body.classList.add('modal-active'); };
                const close = () => { modal.classList.add('pointer-events-none', 'opacity-0'); document.body.classList.remove('modal-active'); };
                if (overlay) overlay.addEventListener('click', close);
                closeButtons.forEach(btn => btn.addEventListener('click', close));
                return { open, close };
            }

            const participantsModal = setupModal('participants-modal');
            const eventModal = setupModal('event-modal');

            // --- PARTICIPANTS MODAL ---
            document.getElementById('participants-card').addEventListener('click', () => { renderParticipantsList(); participantsModal.open(); });
            const participantsList = document.getElementById('participants-list');

            function renderParticipantsList() {
                participantsList.innerHTML = '';
                participantsData.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                    const row = document.createElement('tr'); row.className = 'border-b'; row.dataset.id = p.id;
                    row.innerHTML = `<td class="p-2"><span class="participant-name">${p.name}</span></td><td class="p-2"><span class="participant-phone">${p.phone}</span></td><td class="p-2 text-center space-x-2"><button class="text-blue-500 hover:text-blue-700 edit-participant-btn"><i class="fas fa-edit"></i></button><button class="text-red-500 hover:text-red-700 delete-participant-btn"><i class="fas fa-trash"></i></button></td>`;
                    participantsList.appendChild(row);
                });
            }

            participantsList.addEventListener('click', (e) => {
                const id = parseInt(e.target.closest('tr').dataset.id);
                if (e.target.closest('.delete-participant-btn')) { const index = participantsData.findIndex(p => p.id === id); if (index > -1) { participantsData.splice(index, 1); saveDataToFirestore(); } }
                if (e.target.closest('.edit-participant-btn')) { const row = e.target.closest('tr'); const nameSpan = row.querySelector('.participant-name'); const phoneSpan = row.querySelector('.participant-phone'); row.querySelector('td:first-child').innerHTML = `<input type="text" value="${nameSpan.textContent}" class="w-full p-1 border rounded edit-name-input">`; row.querySelector('td:nth-child(2)').innerHTML = `<input type="text" value="${phoneSpan.textContent}" class="w-full p-1 border rounded edit-phone-input">`; row.querySelector('td:last-child').innerHTML = `<button class="text-green-500 hover:text-green-700 save-participant-btn"><i class="fas fa-check"></i></button>`; }
                if (e.target.closest('.save-participant-btn')) { const row = e.target.closest('tr'); const newName = row.querySelector('.edit-name-input').value; const newPhone = row.querySelector('.edit-phone-input').value; const participant = participantsData.find(p => p.id === id); if (participant && newName) { participant.name = newName; participant.phone = newPhone; saveDataToFirestore(); } }
            });

            document.getElementById('add-participant-btn').addEventListener('click', () => {
                const nameInput = document.getElementById('new-participant-name'); const phoneInput = document.getElementById('new-participant-phone');
                if (nameInput.value.trim()) { participantsData.push({ id: Date.now(), name: nameInput.value.trim(), phone: phoneInput.value.trim() }); saveDataToFirestore(); nameInput.value = ''; phoneInput.value = ''; }
            });

            // --- EVENT MODAL ---
            document.getElementById('add-event-btn').addEventListener('click', () => {
                document.getElementById('event-modal-title').textContent = 'Adicionar Evento';
                document.getElementById('event-id-input').value = '';
                document.getElementById('event-date-input').value = '';
                document.getElementById('event-type-input').value = 'Homens à Mesa';
                document.getElementById('event-location-input').value = '';
                eventModal.open();
            });

            document.getElementById('save-event-btn').addEventListener('click', () => {
                const id = document.getElementById('event-id-input').value;
                const date = document.getElementById('event-date-input').value;
                const type = document.getElementById('event-type-input').value;
                const location = document.getElementById('event-location-input').value;
                if (!date || !type || !location) { alert('Por favor, preencha todos os campos.'); return; }
                if (id) {
                    const event = eventsData.find(e => e.id == id);
                    if (event) { event.date = date; event.type = type; event.location = location; }
                } else {
                    eventsData.push({ id: Date.now(), date, type, location, planning: "", tasks: [], finances: { income: [], expenses: [] }, guests: [], volunteers: [] });
                }
                saveDataToFirestore();
                eventModal.close();
            });

            // --- RENDER DASHBOARD ---
            function renderDashboard() {
                if (!eventsData || !participantsData) return;
                let totalIncome = 0, totalExpenses = 0; eventsData.forEach(event => { totalIncome += (event.finances?.income || []).reduce((sum, item) => sum + item.amount, 0); totalExpenses += (event.finances?.expenses || []).reduce((sum, item) => sum + item.amount, 0); });
                document.getElementById('total-balance').textContent = `R$ ${(totalIncome - totalExpenses).toFixed(2).replace('.', ',')}`;
                document.getElementById('total-participants').textContent = participantsData.length;
                
                const groupedEvents = [...eventsData].sort((a, b) => new Date(a.date) - new Date(b.date)).reduce((acc, event) => { const date = new Date(event.date); const year = date.getUTCFullYear(); const month = date.toLocaleString('pt-BR', { month: 'long', timeZone: 'UTC' }); const capitalizedMonth = month.charAt(0).toUpperCase() + month.slice(1); if (!acc[year]) acc[year] = {}; if (!acc[year][capitalizedMonth]) acc[year][capitalizedMonth] = []; acc[year][capitalizedMonth].push(event); return acc; }, {});
                eventsGrid.innerHTML = '';
                Object.keys(groupedEvents).sort().forEach(year => {
                    const yearHeader = document.createElement('h3'); yearHeader.className = 'text-2xl font-bold text-gray-800 mt-8 mb-4 border-b pb-2'; yearHeader.textContent = `Ano de ${year}`; eventsGrid.appendChild(yearHeader);
                    const monthOrder = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                    Object.keys(groupedEvents[year]).sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b)).forEach(month => {
                         const monthHeader = document.createElement('h4'); monthHeader.className = 'text-xl font-semibold text-gray-600 mb-4'; monthHeader.textContent = month; eventsGrid.appendChild(monthHeader);
                         const monthGrid = document.createElement('div'); monthGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8';
                         groupedEvents[year][month].forEach(event => {
                            const card = document.createElement('div'); card.className = 'bg-white rounded-xl shadow-lg hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300 flex flex-col'; card.dataset.eventId = event.id;
                            card.innerHTML = `<div class="p-6 flex-grow"><div class="flex justify-between items-start"><p class="text-2xl font-bold text-gray-800">${formatDate(event.date)}</p><span class="${getBadgeStyles(event.type)} text-xs font-semibold px-3 py-1 rounded-full">${event.type}</span></div><p class="text-gray-600 mt-2 font-medium"><i class="fas fa-map-marker-alt text-gray-400 mr-2"></i>${event.location}</p></div><div class="bg-gray-50 px-6 py-3 flex justify-between items-center"><button class="edit-event-btn text-gray-500 hover:text-blue-500"><i class="fas fa-edit"></i> Editar</button><a href="#" class="details-link text-blue-500 font-semibold text-sm">Ver Detalhes <i class="fas fa-arrow-right ml-1"></i></a></div>`;
                            card.querySelector('.details-link').addEventListener('click', (e) => { e.preventDefault(); showEventDetail(event.id); });
                            card.querySelector('.edit-event-btn').addEventListener('click', () => {
                                document.getElementById('event-modal-title').textContent = 'Editar Evento';
                                document.getElementById('event-id-input').value = event.id;
                                document.getElementById('event-date-input').value = event.date;
                                document.getElementById('event-type-input').value = event.type;
                                document.getElementById('event-location-input').value = event.location;
                                eventModal.open();
                            });
                            monthGrid.appendChild(card);
                         });
                         eventsGrid.appendChild(monthGrid);
                    });
                });
                dashboardView.classList.remove('hidden'); eventDetailView.classList.add('hidden');
            }

            // --- RENDER EVENT DETAIL & EDITING LOGIC ---
            function showEventDetail(eventId) { const event = eventsData.find(e => e.id == eventId); if (!event) return; tabContentContainer.dataset.eventId = eventId; document.getElementById('event-title').textContent = `${event.type} - ${formatDate(event.date)}`; document.getElementById('event-date-location').textContent = event.location; const badge = document.getElementById('event-type-badge'); badge.textContent = event.type; badge.className = `mt-4 md:mt-0 text-sm font-medium px-4 py-2 rounded-full ${getBadgeStyles(event.type)}`; const tabsContainer = document.getElementById('tabs'); tabsContainer.innerHTML = ''; tabContentContainer.innerHTML = ''; const tabs = [ { id: 'planning', name: 'Planejamento', icon: 'fa-clipboard-list' }, { id: 'tasks', name: 'Divisão de Tarefas', icon: 'fa-tasks' }, { id: 'finances', name: 'Controle Financeiro', icon: 'fa-dollar-sign' }, { id: 'people', name: 'Convidados e Voluntários', icon: 'fa-users' } ]; tabs.forEach((tab, index) => { const button = document.createElement('a'); button.href = '#'; button.className = `tab-button text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm md:text-base mr-2 md:mr-4 ${index === 0 ? 'active' : ''}`; button.innerHTML = `<i class="fas ${tab.icon} mr-2"></i>${tab.name}`; button.dataset.tabId = tab.id; tabsContainer.appendChild(button); const contentPane = document.createElement('div'); contentPane.id = `content-${tab.id}`; contentPane.className = `p-2 ${index !== 0 ? 'hidden' : ''}`; contentPane.innerHTML = generateTabContent(tab.id, event); tabContentContainer.appendChild(contentPane); }); document.querySelectorAll('.tab-button').forEach(button => button.addEventListener('click', (e) => { e.preventDefault(); const tabId = e.currentTarget.dataset.tabId; document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active')); e.currentTarget.classList.add('active'); document.querySelectorAll('#tab-content > div').forEach(pane => pane.classList.add('hidden')); document.getElementById(`content-${tabId}`).classList.remove('hidden'); })); setupEventListeners(event); dashboardView.classList.add('hidden'); eventDetailView.classList.remove('hidden'); }
            
            function generateTabContent(tabId, event) {
                const i = "w-full p-2 border rounded-md bg-white focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition", s = "bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300", a = "bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded-full text-xs leading-none";
                switch (tabId) {
                    case 'planning': return `<h3 class="text-xl font-semibold mb-4 text-gray-700">Planejamento e Plano de Ação</h3><textarea id="planning-input" class="${i}" rows="10">${event.planning || ''}</textarea><div class="text-right mt-4"><button id="save-planning" class="${s}">Salvar Planejamento</button></div>`;
                    case 'tasks':
                        let tasksHtml = `<h3 class="text-xl font-semibold mb-4 text-gray-700">Divisão de Tarefas</h3><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-100"><tr><th class="p-3">Tarefa</th><th class="p-3">Responsável</th><th class="p-3">Status</th><th class="p-3">Ação</th></tr></thead><tbody id="tasks-body">`;
                        (event.tasks || []).forEach(task => { tasksHtml += `<tr><td class="p-2"><input type="text" value="${task.name}" class="${i} task-name"></td><td class="p-2"><input type="text" value="${task.responsible}" class="${i} task-responsible"></td><td class="p-2"><select class="${i} task-status"><option ${task.status === "Pendente" ? "selected" : ""}>Pendente</option><option ${task.status === "Em andamento" ? "selected" : ""}>Em andamento</option><option ${task.status === "Concluído" ? "selected" : ""}>Concluído</option></select></td><td class="p-2 text-center"><button class="${a} remove-btn">&times;</button></td></tr>`; });
                        return tasksHtml + `</tbody></table></div><div class="mt-4 flex justify-between items-center"><button id="add-task" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg">+ Adicionar Tarefa</button><button id="save-tasks" class="${s}">Salvar Tarefas</button></div>`;
                    case 'finances':
                        const incomeRows = (event.finances?.income || []).map((item, index) => `<tr><td class="p-1"><input type="text" value="${item.description}" class="${i} income-desc" data-index="${index}"></td><td class="p-1"><input type="number" value="${item.amount.toFixed(2)}" class="${i} income-amount" step="0.01" data-index="${index}"></td><td class="p-1 text-center"><button class="${a} remove-btn" data-type="income" data-index="${index}">&times;</button></td></tr>`).join("");
                        const expenseRows = (event.finances?.expenses || []).map((item, index) => `
                            <tr>
                                <td class="p-1"><input type="text" value="${item.description}" class="${i} expense-desc" data-index="${index}"></td>
                                <td class="p-1"><input type="number" value="${item.amount.toFixed(2)}" class="${i} expense-amount" step="0.01" data-index="${index}"></td>
                                <td class="p-1 text-center">
                                    ${item.receiptUrl ? `<a href="${item.receiptUrl}" target="_blank" class="bg-blue-500 text-white text-xs px-2 py-1 rounded">Ver Recibo</a>` : 
                                    `<div class="file-input-wrapper">
                                        <button class="file-input-button">Anexar</button>
                                        <input type="file" class="receipt-upload" data-index="${index}" accept="image/*,.pdf">
                                    </div>`}
                                </td>
                                <td class="p-1 text-center"><button class="${a} remove-btn" data-type="expense" data-index="${index}">&times;</button></td>
                            </tr>`).join("");

                        return `<div class="grid grid-cols-1 md:grid-cols-2 gap-8" id="finances-container">
                                <div><h3 class="text-xl font-semibold mb-4 text-gray-700 flex justify-between items-center">Entradas <button id="add-income" class="text-sm bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded-full">+</button></h3><table class="w-full text-left"><thead class="bg-gray-100"><tr><th class="p-2">Descrição</th><th class="p-2">Valor (R$)</th><th class="p-2"></th></tr></thead><tbody id="income-body">${incomeRows}</tbody></table></div>
                                <div><h3 class="text-xl font-semibold mb-4 text-gray-700 flex justify-between items-center">Saídas <button id="add-expense" class="text-sm bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded-full">+</button></h3><table class="w-full text-left"><thead class="bg-gray-100"><tr><th class="p-2">Descrição</th><th class="p-2">Valor (R$)</th><th class="p-2">Anexo</th><th class="p-2"></th></tr></thead><tbody id="expense-body">${expenseRows}</tbody></table></div>
                            </div>
                            <div class="mt-8 pt-4 border-t text-right" id="finance-summary"><h3 class="text-2xl font-bold">Saldo do Evento: <span id="event-balance">R$ 0,00</span></h3></div>
                            <div class="text-right mt-4"><button id="save-finances" class="${s}">Salvar Finanças</button></div>`;
                    case 'people': return `<div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div><h3 class="text-xl font-semibold mb-4 text-gray-700">Lista de Convidados</h3><div id="guests-list" class="space-y-2">${(event.guests || []).map(g=>`<div class="flex items-center"><input type="text" class="${i} guest-name" value="${g}"><button class="ml-2 ${a} remove-btn">&times;</button></div>`).join("")}</div><div class="mt-2 flex"><input type="text" id="new-guest-input" placeholder="Novo convidado" class="${i}"><button id="add-guest" class="ml-2 bg-gray-200 hover:bg-gray-300 px-3 rounded-lg">+</button></div></div><div><h3 class="text-xl font-semibold mb-4 text-gray-700">Lista de Voluntários</h3><div id="volunteers-list" class="space-y-2">${(event.volunteers || []).map(v=>`<div class="flex items-center"><input type="text" class="${i} volunteer-name" value="${v}"><button class="ml-2 ${a} remove-btn">&times;</button></div>`).join("")}</div><div class="mt-2 flex"><input type="text" id="new-volunteer-input" placeholder="Novo voluntário" class="${i}"><button id="add-volunteer" class="ml-2 bg-gray-200 hover:bg-gray-300 px-3 rounded-lg">+</button></div></div></div><div class="text-right mt-4"><button id="save-people" class="${s}">Salvar Listas</button></div>`;
                    default: return "Conteúdo não encontrado."
                }
            }

            function setupEventListeners(event) { 
                tabContentContainer.addEventListener('click', e => { if (e.target.classList.contains('remove-btn') || e.target.parentElement.classList.contains('remove-btn')) { e.target.closest('tr, .flex').remove(); } }); 
                document.getElementById('save-planning')?.addEventListener('click', () => { event.planning = document.getElementById('planning-input').value; showToast('Planejamento salvo!'); saveDataToFirestore(); }); 
                document.getElementById('add-task')?.addEventListener('click', () => { document.getElementById('tasks-body').insertRow().innerHTML = `<tr><td class="p-2"><input type="text" value="" class="w-full p-2 border rounded-md bg-white focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition task-name"></td><td class="p-2"><input type="text" value="" class="w-full p-2 border rounded-md bg-white focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition task-responsible"></td><td class="p-2"><select class="w-full p-2 border rounded-md bg-white focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition task-status"><option>Pendente</option><option>Em andamento</option><option>Concluído</option></select></td><td class="p-2 text-center"><button class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded-full text-xs leading-none remove-btn">&times;</button></td></tr>`; }); 
                document.getElementById('save-tasks')?.addEventListener('click', () => { const newTasks = []; document.querySelectorAll('#tasks-body tr').forEach(row => { const name = row.querySelector('.task-name').value; const responsible = row.querySelector('.task-responsible').value; const status = row.querySelector('.task-status').value; if(name) newTasks.push({ name, responsible, status }); }); event.tasks = newTasks; showToast('Tarefas salvas!'); saveDataToFirestore(); }); 
                
                const financeContainer = document.getElementById('finances-container');
                if(financeContainer) {
                    const updateFinances = () => { let income = 0, expenses = 0; document.querySelectorAll('.income-amount').forEach(i => income += parseFloat(i.value) || 0); document.querySelectorAll('.expense-amount').forEach(e => expenses += parseFloat(e.value) || 0); const balance = income - expenses; const balanceEl = document.getElementById('event-balance'); balanceEl.textContent = `R$ ${balance.toFixed(2).replace('.', ',')}`; balanceEl.className = balance >= 0 ? 'text-green-600' : 'text-red-600'; };
                    financeContainer.addEventListener('input', updateFinances);
                    financeContainer.addEventListener('change', async (e) => {
                        if (e.target.classList.contains('receipt-upload')) {
                            const file = e.target.files[0];
                            const index = e.target.dataset.index;
                            if (!file) return;

                            // Ensure the expense item exists
                            if (!event.finances) event.finances = { income: [], expenses: [] };
                            while (event.finances.expenses.length <= index) {
                                event.finances.expenses.push({ description: '', amount: 0, receiptUrl: null });
                            }
                            if(!event.finances.expenses[index]) event.finances.expenses[index] = { description: '', amount: 0, receiptUrl: null };


                            const button = e.target.previousElementSibling;
                            button.textContent = 'Enviando...';
                            button.disabled = true;

                            const filePath = `receipts/${userId}/${event.id}/${Date.now()}_${file.name}`;
                            const storageRef = ref(storage, filePath);
                            
                            try {
                                const snapshot = await uploadBytes(storageRef, file);
                                const downloadURL = await getDownloadURL(snapshot.ref);
                                
                                event.finances.expenses[index].receiptUrl = downloadURL;
                                await saveDataToFirestore();
                                showToast('Recibo enviado com sucesso!');
                                showEventDetail(event.id); // Refresh the view to show the link
                            } catch (error) {
                                console.error("Upload failed:", error);
                                showToast("Falha no upload.");
                                button.textContent = 'Anexar';
                                button.disabled = false;
                            }
                        }
                    });
                    updateFinances();
                }

                document.getElementById('add-income')?.addEventListener('click', () => { document.getElementById('income-body').insertAdjacentHTML('beforeend', `<tr><td class="p-1"><input type="text" value="" class="w-full p-2 border rounded-md bg-white focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition income-desc"></td><td class="p-1"><input type="number" value="0.00" class="w-full p-2 border rounded-md bg-white focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition income-amount" step="0.01"></td><td class="p-1 text-center"><button class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded-full text-xs leading-none remove-btn">&times;</button></td></tr>`); }); 
                document.getElementById('add-expense')?.addEventListener('click', () => { 
                    const expenseBody = document.getElementById('expense-body');
                    const newIndex = expenseBody.rows.length;
                    expenseBody.insertAdjacentHTML('beforeend', `<tr><td class="p-1"><input type="text" value="" class="w-full p-2 border rounded-md bg-white focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition expense-desc" data-index="${newIndex}"></td><td class="p-1"><input type="number" value="0.00" class="w-full p-2 border rounded-md bg-white focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition expense-amount" step="0.01" data-index="${newIndex}"></td><td class="p-1 text-center"><div class="file-input-wrapper"><button class="file-input-button">Anexar</button><input type="file" class="receipt-upload" data-index="${newIndex}" accept="image/*,.pdf"></div></td><td class="p-1 text-center"><button class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded-full text-xs leading-none remove-btn">&times;</button></td></tr>`); 
                }); 
                document.getElementById('save-finances')?.addEventListener('click', () => { 
                    const newIncome = []; 
                    document.querySelectorAll('#income-body tr').forEach((row) => { 
                        const description = row.querySelector('.income-desc').value; 
                        const amount = parseFloat(row.querySelector('.income-amount').value); 
                        if(description && !isNaN(amount)) newIncome.push({ description, amount }); 
                    }); 
                    
                    const newExpenses = [];
                    document.querySelectorAll('#expense-body tr').forEach((row, index) => { 
                        const description = row.querySelector('.expense-desc').value; 
                        const amount = parseFloat(row.querySelector('.expense-amount').value); 
                        // Try to preserve existing URL if available
                        const existingExpense = event.finances?.expenses?.[index];
                        const receiptUrl = existingExpense?.receiptUrl || null;
                        if(description && !isNaN(amount)) newExpenses.push({ description, amount, receiptUrl }); 
                    }); 
                    
                    if(!event.finances) event.finances = {};
                    event.finances.income = newIncome; 
                    event.finances.expenses = newExpenses; 

                    showToast('Finanças salvas!'); 
                    saveDataToFirestore(); 
                }); 
                
                const addToList = (listId, inputId) => { const input = document.getElementById(inputId); const list = document.getElementById(listId); if(input.value.trim()){ list.insertAdjacentHTML('beforeend', `<div class="flex items-center"><input type="text" class="w-full p-2 border rounded-md bg-white focus:ring-2 focus:ring-blue-300 focus:border-blue-500 transition ${listId === 'guests-list' ? 'guest-name' : 'volunteer-name'}" value="${input.value.trim()}"><button class="ml-2 bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded-full text-xs leading-none remove-btn">&times;</button></div>`); input.value = ''; } }; 
                document.getElementById('add-guest')?.addEventListener('click', () => addToList('guests-list', 'new-guest-input')); 
                document.getElementById('add-volunteer')?.addEventListener('click', () => addToList('volunteers-list', 'new-volunteer-input')); 
                document.getElementById('save-people')?.addEventListener('click', () => { 
                    const newGuests = []; document.querySelectorAll('.guest-name').forEach(i => { if(i.value.trim()) newGuests.push(i.value.trim()); }); 
                    event.guests = newGuests; 
                    const newVolunteers = []; document.querySelectorAll('.volunteer-name').forEach(i => { if(i.value.trim()) newVolunteers.push(i.value.trim()); }); 
                    event.volunteers = newVolunteers; 
                    showToast('Listas salvas!'); 
                    saveDataToFirestore(); 
                }); 
            }

            // --- EVENT LISTENERS ---
            backButton.addEventListener('click', renderDashboard);

        });
    </script>
</body>
</html>

