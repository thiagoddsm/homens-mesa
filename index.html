<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Eventos - Homens à Mesa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s, bottom 0.3s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow-x: hidden;
            overflow-y: hidden;
        }
        /* Style for file input */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-input-button {
            border: 1px solid #ccc;
            display: inline-block;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 6px;
            background-color: #f0f0f0;
            font-size: 12px;
            font-weight: 500;
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
        }
        .code-block {
            background-color: #e5e7eb;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 1rem;
            text-align: left;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex flex-col items-center justify-center z-50">
        <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <div class="text-white text-xl mt-4">Conectando ao servidor...</div>
    </div>

    <!-- Error Container -->
    <div id="error-container" class="hidden container mx-auto my-10 p-8 bg-red-100 border border-red-400 text-red-700 rounded-lg">
        <!-- Error message will be inserted here -->
    </div>

    <!-- Main Container -->
    <div id="main-container" class="container mx-auto p-4 md:p-6 opacity-0 transition-opacity duration-500">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Projeto Homens à Mesa</h1>
            <p class="text-md text-gray-600 mt-2">Painel de Organização de Eventos</p>
        </header>

        <!-- Dashboard View -->
        <main id="dashboard-view">
            <!-- Summary Section -->
            <div id="summary-section" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                <!-- Balance Card -->
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center">
                    <div class="bg-green-100 p-4 rounded-full mr-4">
                        <i class="fas fa-wallet text-2xl text-green-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 font-medium">Saldo Atual em Caixa</p>
                        <p id="total-balance" class="text-3xl font-bold text-gray-800">R$ 0,00</p>
                    </div>
                </div>
                <!-- Participants Card -->
                <div id="participants-card" class="bg-white p-6 rounded-xl shadow-lg flex items-center hover:shadow-xl transition-shadow duration-300 cursor-pointer">
                    <div class="bg-blue-100 p-4 rounded-full mr-4">
                        <i class="fas fa-users text-2xl text-blue-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 font-medium">Homens Cadastrados</p>
                        <p id="total-participants" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-700">Agenda de Eventos</h2>
                <button id="add-event-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 flex items-center">
                    <i class="fas fa-plus mr-2"></i> Adicionar Evento
                </button>
            </div>
            <div id="events-grid">
                <!-- Event cards will be dynamically inserted here by year and month -->
            </div>
        </main>

        <!-- Event Detail View (Initially Hidden) -->
        <section id="event-detail-view" class="hidden">
            <button id="back-to-dashboard" class="mb-6 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Voltar para o Painel
            </button>
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 border-b pb-4">
                    <div>
                        <h2 id="event-title" class="text-3xl font-bold text-gray-900"></h2>
                        <p id="event-date-location" class="text-lg text-gray-500 mt-1"></p>
                    </div>
                    <div id="event-type-badge" class="mt-4 md:mt-0 text-sm font-medium px-4 py-2 rounded-full"></div>
                </div>
                <div class="border-b border-gray-200 mb-6">
                    <nav id="tabs" class="flex flex-wrap -mb-px" aria-label="Tabs"></nav>
                </div>
                <div id="tab-content"></div>
            </div>
        </section>

    </div>
    
    <!-- Participants Modal -->
    <div id="participants-modal" class="modal pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center opacity-0">
        <div id="participants-modal-overlay" class="absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded-xl shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-2xl font-bold">Homens Cadastrados</p>
                    <div class="close-modal cursor-pointer z-50 p-2">
                        <i class="fas fa-times text-2xl text-gray-500 hover:text-gray-800"></i>
                    </div>
                </div>
                <div class="my-5 h-64 overflow-y-auto pr-2">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-3 font-semibold text-sm">Nome</th>
                                <th class="p-3 font-semibold text-sm">Telefone</th>
                                <th class="p-3 font-semibold text-sm text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="participants-list"></tbody>
                    </table>
                </div>
                <div class="pt-4 border-t">
                     <p class="text-lg font-semibold mb-2">Adicionar Novo Participante</p>
                     <div class="flex flex-col md:flex-row md:space-x-2 space-y-2 md:space-y-0">
                        <input id="new-participant-name" type="text" placeholder="Nome completo" class="w-full p-2 border rounded-md">
                        <input id="new-participant-phone" type="tel" placeholder="Telefone" class="w-full md:w-auto p-2 border rounded-md">
                        <button id="add-participant-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">Adicionar</button>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="event-modal" class="modal pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center opacity-0">
        <div id="event-modal-overlay" class="absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <p id="event-modal-title" class="text-2xl font-bold">Adicionar Evento</p>
                    <div class="close-modal cursor-pointer z-50 p-2">
                         <i class="fas fa-times text-2xl text-gray-500 hover:text-gray-800"></i>
                    </div>
                </div>
                <div class="my-5 space-y-4">
                    <input type="hidden" id="event-id-input">
                    <div>
                        <label for="event-date-input" class="block text-sm font-medium text-gray-700">Data</label>
                        <input type="date" id="event-date-input" class="mt-1 w-full p-2 border rounded-md">
                    </div>
                     <div>
                        <label for="event-type-input" class="block text-sm font-medium text-gray-700">Tipo de Evento</label>
                        <select id="event-type-input" class="mt-1 w-full p-2 border rounded-md bg-white">
                            <option>Homens à Mesa</option>
                            <option>Encontrão de Homens</option>
                            <option>Culto de Homens</option>
                        </select>
                    </div>
                    <div>
                        <label for="event-location-input" class="block text-sm font-medium text-gray-700">Local</label>
                        <input type="text" id="event-location-input" class="mt-1 w-full p-2 border rounded-md">
                    </div>
                </div>
                <div class="flex justify-end pt-4 border-t">
                    <button class="close-modal bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg mr-2">Cancelar</button>
                    <button id="save-event-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        document.addEventListener('DOMContentLoaded', function () {
            
            // --- DOM ELEMENTS ---
            const loadingOverlay = document.getElementById('loading-overlay');
            const errorContainer = document.getElementById('error-container');
            const mainContainer = document.getElementById('main-container');

            // --- FIREBASE SETUP ---
            let auth, db, storage, userId;

            const firebaseConfig = typeof __firebase_config !== 'undefined' 
                ? JSON.parse(__firebase_config)
                : {};

            if (!firebaseConfig.apiKey) {
                const errorMsg = "Configuração do Firebase não encontrada. A chave de API não foi carregada.";
                console.error(errorMsg);
                loadingOverlay.style.display = 'none';
                errorContainer.innerHTML = `<strong>Erro Crítico:</strong> ${errorMsg}<br>Por favor, verifique se o ambiente está configurado corretamente.`;
                errorContainer.style.display = 'block';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                loadingOverlay.style.display = 'none';
                errorContainer.innerHTML = `<strong>Erro Crítico:</strong> Falha ao iniciar o Firebase.<br>${e.message}`;
                errorContainer.style.display = 'block';
                return;
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    loadDataFromFirestore();
                } else {
                    try {
                        await signInAnonymously(auth);
                        // The listener will re-run with the new user, so we don't need to do anything here.
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error);
                        loadingOverlay.style.display = 'none';
                        mainContainer.style.display = 'none';
                        errorContainer.innerHTML = `<strong>Falha na Autenticação.</strong><br>Verifique sua conexão com a internet. Se o erro persistir, confirme se o método de login "Anônimo" está ativado no seu painel do Firebase (Authentication -> Sign-in method).<br><br><small>Erro: ${error.message}</small>`;
                        errorContainer.style.display = 'block';
                    }
                }
            });

            // --- DATA ---
            let participantsData = [];
            let eventsData = [];

            async function saveDataToFirestore() {
                if (!userId) return;
                const dataDocRef = doc(db, 'homens-a-mesa-dados', userId);
                try {
                    await setDoc(dataDocRef, { 
                        participants: participantsData,
                        events: eventsData
                    });
                } catch (error) {
                    console.error("Error saving data: ", error);
                    showToast("Erro ao salvar dados.");
                }
            }

            function loadDataFromFirestore() {
                if (!userId) return;
                const dataDocRef = doc(db, 'homens-a-mesa-dados', userId);
                
                const unsubscribe = onSnapshot(dataDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        participantsData = data.participants || [];
                        eventsData = data.events || [];
                    } else {
                        console.log("No data found, setting up default data.");
                        initializeDefaultData();
                        saveDataToFirestore(); 
                    }
                    renderDashboard();
                    loadingOverlay.style.display = 'none';
                    mainContainer.style.opacity = '1';

                }, (error) => {
                    console.error("Error listening to data:", error);
                    loadingOverlay.style.display = 'none';
                    mainContainer.style.display = 'none';
                    
                    const firestoreRules = `
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /homens-a-mesa-dados/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}`;
                    
                    errorContainer.innerHTML = `
                        <strong>Erro de Permissão (Firestore).</strong><br>
                        Não foi possível ler os dados do banco de dados. 
                        <p class="mt-2">
                            Acesse o painel do seu projeto no Firebase, vá para <strong>Firestore Database -> Regras</strong> e substitua o conteúdo pelas seguintes regras:
                        </p>
                        <div class="code-block">${firestoreRules}</div>
                        <p class="mt-4">
                            Após salvar, atualize esta página. Se o erro persistir, verifique também se o Login Anônimo está ativado na aba "Authentication".
                        </p>
                        <small class="mt-2 block">Erro original: ${error.message}</small>
                    `;
                    errorContainer.style.display = 'block';
                });
            }
            
            function initializeDefaultData() {
                participantsData = [
                    { id: 1, name: 'Marcos', phone: '21987654321' }, { id: 2, name: 'Pr Eric', phone: '' }, { id: 3, name: 'Lucas Porto', phone: '' }, { id: 4, name: 'Talisson', phone: '' }, { id: 5, name: 'Neander', phone: '' }, { id: 6, name: 'Alessandro (Rowena)', phone: '' }, { id: 7, name: 'Delcir', phone: '' }, { id: 8, name: 'Pedrinho', phone: '' },
                ];
                eventsData = [
                    { id: 1, date: '2025-10-05', type: 'Homens à Mesa', location: 'Sítio em Monjolos', planning: "1. Definir o tema do encontro e o palestrante.\n2. Preparar o material de estudo e dinâmicas.\n3. Organizar a escala de louvor.\n4. Fazer a lista de compras detalhada.", tasks: [ { name: 'Confirmar com o Pr Eric a palavra', responsible: 'Marcos', status: 'Concluído' }, { name: 'Organizar louvor', responsible: 'Lucas Porto', status: 'Em andamento' }, { name: 'Fazer as compras (carne, bebidas, etc)', responsible: 'Alessandro', status: 'Pendente' }, { name: 'Ligar para os convidados para confirmar presença', responsible: 'Marcos', status: 'Pendente' } ], finances: { income: [ { description: 'Oferta inicial do ministério', amount: 200.00 } ], expenses: [ { description: 'Carvão e acendedores', amount: 35.50 } ] }, guests: ['Pr Eric', 'Lucas Porto', 'Talisson', 'Neander', 'Alessandro (Rowena)', 'Delcir', 'Pedrinho'], volunteers: ['Marcos', 'Neander (Churrasco)', 'Alessandro (Compras)'] },
                    { id: 2, date: '2025-11-15', type: 'Encontrão de Homens', location: 'Sítio em Tanguá', planning: "1. Divulgação massiva no púlpito e nos Grupos de Conexão (GCs).\n2. Organizar opções de transporte (caronas solidárias, van).\n3. Definir cardápio completo do churrasco e acompanhamentos.\n4. Planejar atividades de lazer e gincanas.", tasks: [], finances: { income: [], expenses: [] }, guests: ['Aberto para todos os homens da Igreja'], volunteers: [] },
                    { id: 3, date: '2025-12-07', type: 'Homens à Mesa', location: 'Sítio em Monjolos', planning: "", tasks: [], finances: { income: [], expenses: [] }, guests: [], volunteers: [] },
                ];
                generate2026Schedule();
            }
            
            function generate2026Schedule() {
                const year = 2026;
                const specialEvents = [
                    { month: 3, date: `${year}-04-19`, type: 'Culto de Homens', location: 'Igreja' }, // April
                    { month: 5, date: `${year}-06-21`, type: 'Encontrão de Homens', location: 'Sítio em Tanguá' }, // June
                    { month: 8, date: `${year}-09-20`, type: 'Culto de Homens', location: 'Igreja' }, // September
                    { month: 10, date: `${year}-11-15`, type: 'Encontrão de Homens', location: 'Sítio em Tanguá' }, // November
                ];
                const specialEventMonths = specialEvents.map(e => e.month);
                for (let month = 0; month < 12; month++) {
                    if (specialEventMonths.includes(month)) {
                        const eventData = specialEvents.find(e => e.month === month);
                        eventsData.push({ id: Date.now() + month, date: eventData.date, type: eventData.type, location: eventData.location, planning: "", tasks: [], finances: { income: [], expenses: [] }, guests: [], volunteers: [] });
                    } else {
                        const firstDay = new Date(year, month, 1);
                        const dayOfWeek = firstDay.getDay();
                        const firstSunday = new Date(firstDay);
                        firstSunday.setDate(1 - dayOfWeek + (dayOfWeek > 0 ? 7 : 0));
                        const dateString = firstSunday.toISOString().split('T')[0];
                        eventsData.push({ id: Date.now() + month, date: dateString, type: 'Homens à Mesa', location: 'Sítio em Monjolos', planning: "", tasks: [], finances: { income: [], expenses: [] }, guests: [], volunteers: [] });
                    }
                }
            }


            // --- DOM ELEMENTS ---
            const dashboardView = document.getElementById('dashboard-view');
            const eventDetailView = document.getElementById('event-detail-view');
            const eventsGrid = document.getElementById('events-grid');
            const backButton = document.getElementById('back-to-dashboard');
            const tabContentContainer = document.getElementById('tab-content');
            
            // --- UTILITY FUNCTIONS ---
            function formatDate(dateString) { const options = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'UTC' }; return new Date(dateString).toLocaleDateString('pt-BR', options); }
            function getBadgeStyles(eventType) { switch (eventType) { case 'Homens à Mesa': return 'bg-blue-100 text-blue-800'; case 'Encontrão de Homens': return 'bg-green-100 text-green-800'; case 'Culto de Homens': return 'bg-purple-100 text-purple-800'; default: return 'bg-gray-100 text-gray-800'; } }
            function showToast(message) { const toast = document.getElementById('toast'); toast.textContent = message; toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }
            
            // --- MODAL GENERIC LOGIC ---
            function setupModal(modalId) {
                const modal = document.getElementById(modalId);
                const overlay = document.getElementById(`${modalId}-overlay`);
                const closeButtons = modal.querySelectorAll('.close-modal');
                const open = () => { modal.classList.remove('pointer-events-none', 'opacity-0'); document.body.classList.add('modal-active'); };
                const close = () => { modal.classList.add('pointer-events-none', 'opacity-0'); document.body.classList.remove('modal-active'); };
                if (overlay) overlay.addEventListener('click', close);
                closeButtons.forEach(btn => btn.addEventListener('click', close));
                return { open, close };
            }

            const participantsModal = setupModal('participants-modal');
            const eventModal = setupModal('event-modal');

            // --- PARTICIPANTS MODAL ---
            document.getElementById('participants-card').addEventListener('click', () => { renderParticipantsList(); participantsModal.open(); });
            const participantsList = document.getElementById('participants-list');

            function renderParticipantsList() {
                participantsList.innerHTML = '';
                participantsData.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                    const row = document.createElement('tr'); row.className = 'border-b'; row.dataset.id = p.id;
                    row.innerHTML = `<td class="p-2"><span class="participant-name">${p.name}</span></td><td class="p-2"><span class="participant-phone">${p.phone}</span></td><td class="p-2 text-center space-x-2"><button class="text-blue-500 hover:text-blue-700 edit-participant-btn"><i class="fas fa-edit"></i></button><button class="text-red-500 hover:text-red-700 delete-participant-btn"><i class="fas fa-trash"></i></button></td>`;
                    participantsList.appendChild(row);
                });
            }

            participantsList.addEventListener('click', (e) => {
                const id = parseInt(e.target.closest('tr').dataset.id);
                if (e.target.closest('.delete-participant-btn')) { const index = participantsData.findIndex(p => p.id === id); if (index > -1) { participantsData.splice(index, 1); saveDataToFirestore(); } }
                if (e.target.closest('.edit-participant-btn')) { const row = e.target.closest('tr'); const nameSpan = row.querySelector('.participant-name'); const phoneSpan = row.querySelector('.participant-phone'); row.querySelector('td:first-child').innerHTML = `<input type="text" value="${nameSpan.textContent}" class="w-full p-1 border rounded edit-name-input">`; row.querySelector('td:nth-child(2)').innerHTML = `<input type="text" value="${phoneSpan.textContent}" class="w-full p-1 border rounded edit-phone-input">`; row.querySelector('td:last-child').innerHTML = `<button class="text-green-500 hover:text-green-700 save-participant-btn"><i class="fas fa-check"></i></button>`; }
                if (e.target.closest('.save-participant-btn')) { const row = e.target.closest('tr'); const newName = row.querySelector('.edit-name-input').value; const newPhone = row.querySelector('.edit-phone-input').value; const participant = participantsData.find(p => p.id === id); if (participant && newName) { participant.name = newName; participant.phone = newPhone; saveDataToFirestore(); } }
            });

            document.getElementById('add-participant-btn').addEventListener('click', () => {
                const nameInput = document.getElementById('new-participant-name'); const phoneInput = document.getElementById('new-participant-phone');
                if (nameInput.value.trim()) { participantsData.push({ id: Date.now(), name: nameInput.value.trim(), phone: phoneInput.value.trim() }); saveDataToFirestore(); nameInput.value = ''; phoneInput.value = ''; }
            });

            // --- EVENT MODAL ---
            document.getElementById('add-event-btn').addEventListener('click', () => {
                document.getElementById('event-modal-title').textContent = 'Adicionar Evento';
                document.getElementById('event-id-input').value = '';
                document.getElementById('event-date-input').value = '';
                document.getElementById('event-type-input').value = 'Homens à Mesa';
                document.getElementById('event-location-input').value = '';
                eventModal.open();
            });

            document.getElementById('save-event-btn').addEventListener('click', () => {
                const id = document.getElementById('event-id-input').value;
                const date = document.getElementById('event-date-input').value;
                const type = document.getElementById('event-type-input').value;
                const location = document.getElementById('event-location-input').value;
                if (!date || !type || !location) { alert('Por favor, preencha todos os campos.'); return; }
                if (id) {
                    const event = eventsData.find(e => e.id == id);
                    if (event) { event.date = date; event.type = type; event.location = location; }
                } else {
                    eventsData.push({ id: Date.now(), date, type, location, planning: "", tasks: [], finances: { income: [], expenses: [] }, guests: [], volunteers: [] });
                }
                saveDataToFirestore();
                eventModal.close();
            });

            // --- RENDER DASHBOARD ---
            function renderDashboard() {
                if (!eventsData || !participantsData) return;
                let totalIncome = 0, totalExpenses = 0; eventsData.forEach(event => { totalIncome += (event.finances?.income || []).reduce((sum, item) => sum + item.amount, 0); totalExpenses += (event.finances?.expenses || []).reduce((sum, item) => sum + item.amount, 0); });
                document.getElementById('total-balance').textContent = `R$ ${(totalIncome - totalExpenses).toFixed(2).replace('.', ',')}`;
                document.getElementById('total-participants').textContent = participantsData.length;
                
                const groupedEvents = [...eventsData].sort((a, b) => new Date(a.date) - new Date(b.date)).reduce((acc, event) => { const date = new Date(event.date); const year = date.getUTCFullYear(); const month = date.toLocaleString('pt-BR', { month: 'long', timeZone: 'UTC' }); const capitalizedMonth = month.charAt(0).toUpperCase() + month.slice(1); if (!acc[year]) acc[year] = {}; if (!acc[year][capitalizedMonth]) acc[year][capitalizedMonth] = []; acc[year][capitalizedMonth].push(event); return acc; }, {});
                eventsGrid.innerHTML = '';
                Object.keys(groupedEvents).sort().forEach(year => {
                    const yearHeader = document.createElement('h3'); yearHeader.className = 'text-2xl font-bold text-gray-800 mt-8 mb-4 border-b pb-2'; yearHeader.textContent = `Ano de ${year}`; eventsGrid.appendChild(yearHeader);
                    const monthOrder = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                    Object.keys(groupedEvents[year]).sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b)).forEach(month => {
                         const monthHeader = document.createElement('h4'); monthHeader.className = 'text-xl font-semibold text-gray-600 mb-4'; monthHeader.textContent = month; eventsGrid.appendChild(monthHeader);
                         const monthGrid = document.createElement('div'); monthGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8';
                         groupedEvents[year][month].forEach(event => {
                            const card = document.createElement('div'); card.className = 'bg-white rounded-xl shadow-lg hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300 flex flex-col'; card.dataset.eventId = event.id;
                            card.innerHTML = `<div class="p-6 flex-grow"><div class="flex justify-between items-start"><p class="text-2xl font-bold text-gray-800">${formatDate(event.date)}</p><span class="${getBadgeStyles(event.type)} text-xs font-semibold px-3 py-1 rounded-full">${event.type}</span></div><p class="text-gray-600 mt-2 font-medium"><i class="fas fa-map-marker-alt text-gray-400 mr-2"></i>${event.location}</p></div><div class="bg-gray-50 px-6 py-3 flex justify-between items-center"><button class="edit-event-btn text-gray-500 hover:text-blue-500"><i class="fas fa-edit"></i> Editar</button><a href="#" class="details-link text-blue-50

